rules_version = '2';
service cloud.firestore {
  match /databases/{db}/documents {

    /* ===================== HELPERS ===================== */
    function hasAuth() { return request.auth != null; }

    function userDoc() {
      return hasAuth()
        ? get(/databases/$(db)/documents/users/$(request.auth.uid))
        : null;
    }

    /* ROLE: SIEMPRE CLAIMS PRIMERO */
    function role() {
      return hasAuth()
        ? (request.auth.token.role != null
            ? request.auth.token.role
            : (userDoc() != null && userDoc().data.role != null
                ? userDoc().data.role
                : null))
        : null;
    }

    function clientId() {
      return hasAuth()
        ? (userDoc() != null && userDoc().data.clientId != null
            ? userDoc().data.clientId
            : null)
        : null;
    }

    function managedClientIds() {
      return hasAuth()
        && userDoc() != null
        && userDoc().data.managedClientIds is list
        ? userDoc().data.managedClientIds
        : [];
    }

    function isSuperAdmin() {
      return request.auth.token.superadmin == true || role() == 'superadmin';
    }

    function isAdmin() {
      return role() == 'admin';
    }

    /* STAFF = SOLO ADMIN / SUPERADMIN */
    function isStaff() {
      return isSuperAdmin() || isAdmin();
    }

    /* PARTNER = SOLO PARTNER_ADMIN */
    function isPartnerAdmin() {
      return role() == 'partner_admin';
    }

    function isManagedClient(cid) {
      return isPartnerAdmin() && managedClientIds().hasAny([cid]);
    }

    function isOwner(cid) {
      return clientId() != null && clientId() == cid;
    }

    /* ===================== USERS ===================== */
    match /users/{uid} {
      allow read: if isStaff() || (hasAuth() && uid == request.auth.uid);

      allow create: if isStaff() || (hasAuth() && uid == request.auth.uid);

      /* SELF UPDATE MUY LIMITADO (NO ROLE, NO managedClientIds) */
      allow update: if isStaff()
        || (hasAuth() && uid == request.auth.uid
            && request.resource.data.diff(resource.data).changedKeys().hasOnly([
              'displayName',
              'phone',
              'photoUrl',
              'updatedAt'
            ]));

      allow delete: if isSuperAdmin();
    }

    /* ===================== CLIENTS ===================== */
    match /clients/{id} {
      allow read: if isStaff()
        || isOwner(id)
        || isManagedClient(id);

      /* Partner puede crear clientes SOLO para s√≠ */
      allow create: if isStaff()
        || (isPartnerAdmin() && request.resource.data.managerUid == request.auth.uid);

      allow update: if isStaff()
        || (isOwner(id) && request.resource.data.diff(resource.data)
            .changedKeys().hasOnly(['name','phone','country','state','city','address']))
        || (isPartnerAdmin()
            && resource.data.managerUid == request.auth.uid
            && request.resource.data.managerUid == resource.data.managerUid);

      allow delete: if isStaff();
    }

    /* ===================== INBOUND PACKAGES ===================== */
    match /inboundPackages/{inbId} {
      allow read: if isStaff()
        || isOwner(resource.data.clientId)
        || isManagedClient(resource.data.clientId);

      /* Partner NO puede crear */
      allow create: if isStaff();

      allow update: if isStaff();

      allow delete: if isStaff();
    }

    /* ===================== BOXES ===================== */
    match /boxes/{boxId} {
      allow read: if isStaff()
        || isOwner(resource.data.clientId)
        || isManagedClient(resource.data.clientId);

      allow create: if isStaff();
      allow update: if isStaff();
      allow delete: if isStaff();
    }

    /* ===================== SHIPMENTS ===================== */
    match /shipments/{id} {
      allow read: if isStaff();
      allow write: if isStaff();
    }

    /* ===================== ADMINS ===================== */
    match /admins/{uid} {
      allow read, write: if isSuperAdmin();
    }

    /* ===================== COUNTERS ===================== */
    match /counters/{id} {
      allow read, write: if hasAuth();
    }
  }
}
