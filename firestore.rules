rules_version = '2';
service cloud.firestore {
  match /databases/{db}/documents {

    /* ===================== HELPERS ===================== */
    function hasAuth() { return request.auth != null; }

    function userDoc() {
      return hasAuth()
        ? get(/databases/$(db)/documents/users/$(request.auth.uid))
        : null;
    }

    /* ROLE: CLAIMS PRIMERO, PERO FIRESTORE `partner_admin` OVERRIDES (claims stale hardening) */
    function role() {
      return hasAuth()
        ? (
            (userDoc() != null && userDoc().data.role == 'partner_admin')
              ? 'partner_admin'
              : (
                  request.auth.token.role != null
                    ? request.auth.token.role
                    : (
                        userDoc() != null && userDoc().data.role != null
                          ? userDoc().data.role
                          : null
                      )
                )
          )
        : null;
    }

    function clientId() {
      return hasAuth()
        ? (userDoc() != null && userDoc().data.clientId != null
            ? userDoc().data.clientId
            : null)
        : null;
    }

    function managedClientIds() {
      return hasAuth()
        && userDoc() != null
        && userDoc().data.managedClientIds is list
        ? userDoc().data.managedClientIds
        : [];
    }

    function isSuperAdmin() {
      return request.auth.token.superadmin == true || role() == 'superadmin';
    }

    function isAdmin() {
      return request.auth.token.admin == true || role() == 'admin';
    }

    function isOperador() {
      return role() == 'operador';
    }

    // Claims-only staff check (avoids recursive dependency on userDoc())
    function isStaffClaim() {
      return request.auth.token.superadmin == true
        || request.auth.token.role == 'superadmin'
        || request.auth.token.role == 'admin'
        || request.auth.token.role == 'operador';
    }

    // Claims-only privileged staff check (avoids recursive dependency on userDoc())
    function isPrivilegedStaffClaim() {
      return request.auth.token.superadmin == true
        || request.auth.token.role == 'superadmin'
        || request.auth.token.role == 'admin';
    }

    /* STAFF OPERATIVO = SUPERADMIN / ADMIN / OPERADOR */
    function isStaff() {
      return isSuperAdmin() || isAdmin() || isOperador();
    }

    /* STAFF PRIVILEGIADO = SUPERADMIN / ADMIN (sin operador) */
    function isPrivilegedStaff() {
      return isSuperAdmin() || isAdmin();
    }

    /* PARTNER = SOLO PARTNER_ADMIN */
    function isPartnerAdmin() {
      return role() == 'partner_admin';
    }

    function isManagedClient(cid) {
      return isPartnerAdmin()
        && (cid is string)
        && managedClientIds().hasAny([cid]);
    }

    function isClientManagedByUid(cid) {
      return isPartnerAdmin()
        && (cid is string)
        && get(/databases/$(db)/documents/clients/$(cid)).exists()
        && get(/databases/$(db)/documents/clients/$(cid)).data.managerUid == request.auth.uid;
    }

    function isOwner(cid) {
      return clientId() != null && clientId() == cid;
    }

    /* ===================== USERS ===================== */
    match /users/{uid} {
      // IMPORTANT: avoid isStaff()/role() here to prevent recursion via userDoc()
      allow read: if isPrivilegedStaffClaim() || (hasAuth() && uid == request.auth.uid);

      allow create: if isPrivilegedStaffClaim() || (hasAuth() && uid == request.auth.uid);

      /* SELF UPDATE MUY LIMITADO (NO ROLE, NO managedClientIds) */
      allow update: if isPrivilegedStaffClaim()
        || (hasAuth() && uid == request.auth.uid
            && request.resource.data.diff(resource.data).changedKeys().hasOnly([
              'displayName',
              'phone',
              'photoUrl',
              'updatedAt'
            ]));

      allow delete: if request.auth.token.superadmin == true;
    }

    /* ===================== CLIENTS ===================== */
    match /clients/{id} {
      allow read: if isStaff()
        || isOwner(id)
        || isManagedClient(id)
        || (isPartnerAdmin() && resource.data.managerUid == request.auth.uid);

      /* Partner puede crear clientes SOLO para sí */
      allow create: if isStaff()
        || (isPartnerAdmin() && request.resource.data.managerUid == request.auth.uid);

      allow update: if isStaff()
        || (isOwner(id) && request.resource.data.diff(resource.data)
            .changedKeys().hasOnly([
              'name','phone','country','state','city','address',
              'postalCode','emailAlt','docType','docNumber','contact'
            ]))
        || (isPartnerAdmin()
            && resource.data.managerUid == request.auth.uid
            && request.resource.data.managerUid == resource.data.managerUid
            && request.resource.data.diff(resource.data).changedKeys().hasOnly([
              'name','phone','country','state','city','address',
              'postalCode','emailAlt','docType','docNumber','contact',
              'activo'
            ]));

      allow delete: if false;
    }

    /* ===================== INBOUND PACKAGES ===================== */
    match /inboundPackages/{inbId} {
      allow read: if isStaff()
        || (
          isPartnerAdmin()
          && (
            // PRIMARY: allow by managedClientIds
            isManagedClient(resource.data.clientId)
            // Fallback: allow if the client doc is managed by this partner
            || isClientManagedByUid(resource.data.clientId)
            // Back-compat: inbound may store managerUid directly
            || (resource.data.managerUid == request.auth.uid)
          )
        );

      /* Partner NO puede crear */
      allow create: if isStaff();

      allow update: if isStaff();

      allow delete: if isStaff();
    }

    /* ===================== BOXES ===================== */
    match /boxes/{boxId} {
      allow read: if isStaff()
        || (
          isPartnerAdmin()
          && (
            // PRIMARY: allow by managedClientIds
            isManagedClient(resource.data.clientId)
            // Fallback: allow if the client doc is managed by this partner
            || isClientManagedByUid(resource.data.clientId)
            // Back-compat: box may store managerUid directly
            || (resource.data.managerUid == request.auth.uid)
          )
        );

      allow create: if isStaff();

      allow update: if isPrivilegedStaff()
        || (isOperador()
            && !request.resource.data.diff(resource.data).changedKeys().hasAny(['weightOverrideLb']));
      // NOTA: Si en el futuro se permite que isPartnerAdmin() actualice boxes,
      // asegurar que weightOverrideLb esté explícitamente excluido en changedKeys().hasOnly([...])

      allow delete: if isStaff();
    }

    /* ===================== SHIPMENTS ===================== */
    match /shipments/{id} {
      allow read: if isStaff()
        || (
          // Client view
          resource.data.clientIds != null
          && clientId() != null
          && clientId() in resource.data.clientIds
        )
        || (
          // Partner view by managed clients
          isPartnerAdmin()
          && resource.data.clientIds != null
          && resource.data.clientIds.hasAny(managedClientIds())
        );

    // Staff can create/update. Deletion is restricted below.
    allow create, update: if isStaff();
    allow delete: if isPrivilegedStaff() && (resource.data.boxIds == null || resource.data.boxIds.size() == 0);
    }

    /* ===================== ADMINS ===================== */
    match /admins/{uid} {
      allow read, write: if isSuperAdmin();
    }

    /* ===================== COUNTERS ===================== */
    match /counters/{id} {
      allow read, write: if isStaff();
    }
  }
}
